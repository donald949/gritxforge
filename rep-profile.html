<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grit x Forge Training Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2c3e50;
            min-height: 100vh;
            padding: 0;
            line-height: 1.6;
        }

        .sidebar {
            width: 60px;
            background: #2c3e50;
            transition: width 0.3s ease;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            overflow: hidden;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar.expanded {
            width: 250px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 70px;
        }

        .sidebar-logo {
            color: #a10e02;
            font-weight: 700;
            font-size: 1.5em;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar.expanded .sidebar-logo {
            opacity: 1;
        }

        .sidebar-toggle {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 3px solid transparent;
            white-space: nowrap;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .nav-item.active {
            background: rgba(161, 14, 2, 0.1);
            color: #a10e02;
            border-left-color: #a10e02;
        }
        
        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logout-btn {
            background: none;
            border: none;
            width: 100%;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(161, 14, 2, 0.2);
            color: #ff6b6b;
        }

        .nav-item svg {
            min-width: 20px;
            width: 20px;
            height: 20px;
            margin-right: 15px;
        }

        .nav-item span {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar.expanded .nav-item span {
            opacity: 1;
        }

        .container {
            margin-left: 60px;
            padding: 40px;
            background: #ffffff;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .sidebar.expanded ~ .container {
            margin-left: 250px;
        }

        /* Hamburger Menu for Mobile */
        .hamburger {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #2c3e50;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            width: 44px;
            height: 44px;
            justify-content: center;
            align-items: center;
        }

        .hamburger-icon {
            width: 20px;
            height: 20px;
            position: relative;
        }
        
        .hamburger-icon span {
            display: block;
            position: absolute;
            height: 2px;
            width: 100%;
            background: white;
            border-radius: 1px;
            opacity: 1;
            left: 0;
            transform: rotate(0deg);
            transition: .25s ease-in-out;
        }
        
        .hamburger-icon span:nth-child(1) {
            top: 0px;
        }
        
        .hamburger-icon span:nth-child(2),
        .hamburger-icon span:nth-child(3) {
            top: 8px;
        }
        
        .hamburger-icon span:nth-child(4) {
            top: 16px;
        }
        
        .hamburger-icon.active span:nth-child(1) {
            top: 8px;
            width: 0%;
            left: 50%;
        }
        
        .hamburger-icon.active span:nth-child(2) {
            transform: rotate(45deg);
        }
        
        .hamburger-icon.active span:nth-child(3) {
            transform: rotate(-45deg);
        }
        
        .hamburger-icon.active span:nth-child(4) {
            top: 8px;
            width: 0%;
            left: 50%;
        }

        /* Mobile Sidebar Styles */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 250px;
            }

            .sidebar.expanded {
                transform: translateX(0);
            }

            .container {
                margin-left: 0;
                padding-top: 80px;
            }

            .sidebar.expanded ~ .container {
                margin-left: 0;
            }

            .hamburger {
                display: flex;
            }

            /* Overlay when sidebar is open on mobile */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .sidebar-overlay.active {
                display: block;
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left {
            flex: 1;
        }

        .header-left h1 {
            font-size: 2.2em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .brand-highlight {
            color: #a10e02;
        }

        .header-left p {
            color: #6c757d;
            font-size: 0.95em;
        }

        .prospect-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e8ecef;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: 600;
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1.1em;
            color: #2c3e50;
            font-weight: 500;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-lead { background: #fff3cd; color: #856404; }
        .status-contacted { background: #cfe2ff; color: #084298; }
        .status-interview_scheduled { background: #d1ecf1; color: #0c5460; }
        .status-hired { background: #d4edda; color: #155724; }

        .progress-overview {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e8ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-completed { color: #28a745; }
        .stat-pending { color: #ffc107; }
        .stat-total { color: #6c757d; }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-bar-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #495057;
        }

        .training-timeline {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e8ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .timeline-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 25px;
            position: relative;
        }

        .timeline-step:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 20px;
            top: 40px;
            bottom: -25px;
            width: 2px;
            background: #e9ecef;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        .step-completed {
            background: #28a745;
            color: white;
        }

        .step-current {
            background: #ffc107;
            color: #212529;
        }

        .step-pending {
            background: #e9ecef;
            color: #6c757d;
        }

        .step-self-completed {
            background: #17a2b8;
            color: white;
            border: 3px solid #ffc107;
        }

        .step-content {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e8ecef;
        }

        .step-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .step-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .step-meta {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .step-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .notes-section {
            margin-top: 15px;
        }

        .notes-tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 15px;
        }

        .notes-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .notes-tab.active {
            color: #a10e02;
            border-bottom-color: #a10e02;
        }

        .notes-content {
            display: none;
        }

        .notes-content.active {
            display: block;
        }

        .notes-display {
            background: white;
            border: 1px solid #e8ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            min-height: 100px;
            white-space: pre-wrap;
            color: #495057;
        }

        .notes-display.empty {
            color: #6c757d;
            font-style: italic;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e8ecef;
            border-radius: 6px;
            font-size: 14px;
            background: #ffffff;
            color: #495057;
            transition: all 0.3s ease;
            resize: vertical;
            min-height: 100px;
        }

        textarea:focus {
            outline: none;
            border-color: #a10e02;
            box-shadow: 0 0 0 3px rgba(161, 14, 2, 0.1);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .alert.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .permission-note {
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
            padding: 15px;
            margin: 15px 0;
            font-style: italic;
            color: #6c757d;
        }

        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-info {
            background: #f8f9fa;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #495057;
            border: 1px solid #e8ecef;
        }

        .user-info strong {
            color: #a10e02;
        }

        @media (max-width: 768px) {
            .container {
                margin-left: 0;
                padding: 25px 20px;
            }

            .prospect-info {
                grid-template-columns: 1fr;
            }

            .progress-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .step-content {
                margin-left: -60px;
                margin-top: 10px;
            }

            .timeline-step {
                flex-direction: column;
            }

            .step-icon {
                margin-bottom: 10px;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Hamburger Menu for Mobile -->
    <button class="hamburger" onclick="toggleSidebar()">
        <div class="hamburger-icon">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
        </div>
    </button>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <svg width="20" height="20" fill="white" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z"/>
                </svg>
            </button>
        </div>
        <nav class="sidebar-nav">
            <a href="index.html" class="nav-item">
                <svg fill="currentColor" viewBox="0 0 16 16">
                    <path d="M0 1.5A1.5 1.5 0 0 1 1.5 0h2A1.5 1.5 0 0 1 5 1.5v2A1.5 1.5 0 0 1 3.5 5h-2A1.5 1.5 0 0 1 0 3.5v-2zM1.5 1a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5h2a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 0-.5-.5h-2zM0 8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V8zm1 3v2a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2H1zm14-1V8a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v2h14zM2 8.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0 4a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5z"/>
                </svg>
                <span>Calculator</span>
            </a>
            <a href="crm.html" class="nav-item" id="nav-crm" style="display: none;">
                <svg fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                    <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                </svg>
                <span>CRM Dashboard</span>
            </a>
            <a href="my-training.html" class="nav-item" id="nav-my-training" style="display: none;">
                <svg fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8.5 2.687c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.81 8.985.936 8 1.783z"/>
                </svg>
                <span>My Training</span>
            </a>
            <div class="nav-item active">
                <svg fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8.211 2.047a.5.5 0 0 0-.422 0l-7.5 3.5a.5.5 0 0 0 .025.917l7.5 3a.5.5 0 0 0 .372 0L14 7.14V13a1 1 0 0 0-1 1v2h3v-2a1 1 0 0 0-1-1V6.739l.686-.275a.5.5 0 0 0 .025-.917l-7.5-3.5ZM8 8.46 1.758 5.965 8 3.052l6.242 2.913L8 8.46Z"/>
                    <path d="M4.176 9.032a.5.5 0 0 0-.656.327l-.5 1.7a.5.5 0 0 0 .294.605l4.5 1.8a.5.5 0 0 0 .372 0l4.5-1.8a.5.5 0 0 0 .294-.605l-.5-1.7a.5.5 0 0 0-.656-.327L8 10.466 4.176 9.032Z"/>
                </svg>
                <span>Training Tracker</span>
            </div>
            <a href="admin.html" class="nav-item" id="nav-admin" style="display: none;">
                <svg fill="currentColor" viewBox="0 0 16 16">
                    <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/>
                </svg>
                <span>Admin Portal</span>
            </a>
        </nav>
        <!-- Logout button at bottom of sidebar -->
        <div class="sidebar-footer">
            <button onclick="logout()" class="nav-item logout-btn">
                <svg fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                    <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708L12.707 4.5a.5.5 0 1 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.294 2.146a.5.5 0 0 0 .708.708l3.147-2.856z"/>
                </svg>
                <span>Logout</span>
            </button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1><span class="brand-highlight">Grit x Forge</span> Training Tracker</h1>
                <p id="prospect-name-header">Loading prospect information...</p>
            </div>
            <div class="header-right">
                <div class="user-info">
                    Logged in as: <strong id="current-user-name"></strong> (<span id="current-user-role"></span>)
                </div>
            </div>
        </div>

        <div id="alert-message" class="alert"></div>

        <!-- Prospect Information -->
        <div class="prospect-info" id="prospect-info">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Trainer Assignment Section -->
        <div class="trainer-assignment-section" id="trainer-assignment-section" style="background: white; padding: 25px; border-radius: 12px; border: 1px solid #e8ecef; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); margin-bottom: 30px; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #2c3e50; font-size: 1.4em;">Assigned Trainers</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-warning" onclick="openGlobalInternalNotesModal()" id="global-internal-notes-btn">Internal Notes</button>
                    <button class="btn btn-success" onclick="openGlobalAssignTrainerModal()" id="assign-trainer-btn">Add Trainer</button>
                </div>
            </div>
            <div id="assigned-trainers-list" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e8ecef; min-height: 60px;">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Progress Overview -->
        <div class="progress-overview">
            <h2 style="margin-bottom: 20px; color: #2c3e50; font-size: 1.4em;">Training Progress Overview</h2>
            
            <div class="progress-stats" id="progress-stats">
                <!-- Will be populated by JavaScript -->
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" id="overall-progress-bar"></div>
            </div>
            <div class="progress-text" id="progress-text"></div>
        </div>

        <!-- Training Timeline -->
        <div class="training-timeline">
            <h2 style="margin-bottom: 25px; color: #2c3e50; font-size: 1.4em;">Training Steps</h2>
            <div id="training-timeline">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Assign Trainer Modal -->
    <div id="assign-trainer-modal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-content" style="background: white; margin: 15% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px;">
            <div class="modal-header" style="margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin: 0;">Assign Trainer</h3>
            </div>
            <form id="assign-trainer-form">
                <input type="hidden" id="assign-step-id">
                <div style="margin-bottom: 20px;">
                    <label for="trainer-select" style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Select Trainer:</label>
                    <select id="trainer-select" required style="width: 100%; padding: 12px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 14px;">
                        <option value="">Choose a trainer...</option>
                        <!-- Will be populated by JavaScript -->
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="trainer-notes" style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Initial Notes (optional):</label>
                    <textarea id="trainer-notes" placeholder="Add any initial instructions or notes for the trainer..." style="width: 100%; padding: 12px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 14px; min-height: 80px; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeAssignTrainerModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Assign Trainer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Global Internal Notes Modal -->
    <div id="global-internal-notes-modal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-content" style="background: white; margin: 10% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 700px;">
            <div class="modal-header" style="margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin: 0;">Internal Notes for Rep</h3>
                <p style="color: #6c757d; margin: 5px 0 0 0; font-size: 14px;">Private notes visible only to trainers, managers, and admins</p>
            </div>
            <div style="margin-bottom: 20px;">
                <div id="global-internal-notes-display" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e8ecef; min-height: 150px; max-height: 400px; overflow-y: auto;">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            <form id="global-internal-notes-form">
                <div style="margin-bottom: 20px;">
                    <label for="global-internal-notes-text" style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Add Internal Note:</label>
                    <textarea id="global-internal-notes-text" placeholder="Add a private note about this rep's training progress..." style="width: 100%; padding: 12px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 14px; min-height: 100px; resize: vertical;" required></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeGlobalInternalNotesModal()">Cancel</button>
                    <button type="submit" class="btn btn-warning">Add Note</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Global Assign Trainer Modal -->
    <div id="global-assign-trainer-modal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-content" style="background: white; margin: 10% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 600px;">
            <div class="modal-header" style="margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin: 0;">Assign Trainer</h3>
                <p style="color: #6c757d; margin: 5px 0 0 0; font-size: 14px;">Assign a trainer to specific steps or all unassigned steps</p>
            </div>
            <form id="global-assign-trainer-form">
                <div style="margin-bottom: 20px;">
                    <label for="global-trainer-select" style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Select Trainer:</label>
                    <select id="global-trainer-select" required style="width: 100%; padding: 12px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 14px;">
                        <option value="">Choose a trainer...</option>
                        <!-- Will be populated by JavaScript -->
                    </select>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Assignment Type:</label>
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; margin-bottom: 10px; font-weight: normal;">
                            <input type="radio" name="assignment-type" value="all" checked style="margin-right: 8px;">
                            Assign to all unassigned training steps
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="radio" name="assignment-type" value="specific" style="margin-right: 8px;">
                            Assign to specific step(s)
                        </label>
                    </div>
                    
                    <div id="specific-steps-selection" style="display: none; margin-top: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Select Training Steps:</label>
                        <div id="steps-checklist" style="max-height: 200px; overflow-y: auto; border: 1px solid #e8ecef; border-radius: 8px; padding: 10px;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label for="global-trainer-notes" style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Initial Notes (optional):</label>
                    <textarea id="global-trainer-notes" placeholder="Add any initial instructions or notes for this trainer assignment..." style="width: 100%; padding: 12px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 14px; min-height: 100px; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeGlobalAssignTrainerModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Assign Trainer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Include Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://tbntifrdpyzdtsofbclq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRibnRpZnJkcHl6ZHRzb2ZiY2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxOTYwOTYsImV4cCI6MjA3OTc3MjA5Nn0.GfHb3086SmNfrRYaNLp1JZVtlUf7SWyoCedclvf9D4w';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentSession = null;
        let prospectId = null;
        let prospectData = null;
        let trainingSteps = [];
        let trainingProgress = [];
        let allTrainers = [];
        let assignedTrainers = [];
        let globalInternalNotes = [];

        // Check authentication and permissions
        function checkAuth() {
            const session = localStorage.getItem('gritSession');
            if (!session) {
                window.location.href = 'login.html';
                return null;
            }

            const sessionData = JSON.parse(session);

            // Allow access for all roles, but with different permissions
            return sessionData;
        }

        // Get prospect ID from URL parameters
        function getProspectId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Initialize page
        async function init() {
            currentSession = checkAuth();
            if (!currentSession) return;

            // Display user info
            const displayName = currentSession.firstName && currentSession.lastName ? 
                `${currentSession.firstName} ${currentSession.lastName}` : 
                currentSession.email;
            document.getElementById('current-user-name').textContent = displayName;
            document.getElementById('current-user-role').textContent = currentSession.role;

            // Show navigation based on role
            // Show My Training link for all users
            document.getElementById('nav-my-training').style.display = 'flex';
            
            if (['Veteran', 'Manager', 'Admin'].includes(currentSession.role)) {
                document.getElementById('nav-crm').style.display = 'flex';
            }
            
            if (currentSession.role === 'Admin') {
                document.getElementById('nav-admin').style.display = 'flex';
            }

            // Get prospect ID from URL
            prospectId = getProspectId();
            if (!prospectId) {
                showAlert('No prospect ID provided. Redirecting to CRM...', 'warning');
                setTimeout(() => window.location.href = 'crm.html', 2000);
                return;
            }

            // Load all data
            await loadProspectData();
            await loadTrainingSteps();
            await loadTrainingProgress();
            await loadTrainers();
            await loadAssignedTrainers();
            await checkPermissionsAndLoadGlobalNotes();
            renderProspectInfo();
            renderProgressOverview();
            renderTrainingTimeline();
            
            // Show trainer assignment section will be handled by permission checking
            await updateUIBasedOnPermissions();
        }

        // Load prospect information
        async function loadProspectData() {
            try {
                const { data: prospect, error } = await supabase
                    .from('prospects')
                    .select(`
                        *,
                        recruiter:assigned_recruiter_id (
                            id,
                            email,
                            first_name,
                            last_name,
                            role
                        )
                    `)
                    .eq('id', prospectId)
                    .single();

                if (error) throw error;
                
                prospectData = prospect;
                document.getElementById('prospect-name-header').textContent = 
                    `${prospect.first_name} ${prospect.last_name} - Training Progress`;

            } catch (error) {
                console.error('Error loading prospect:', error);
                showAlert('Failed to load prospect information: ' + error.message, 'warning');
            }
        }

        // Load training steps
        async function loadTrainingSteps() {
            try {
                const { data: steps, error } = await supabase
                    .from('training_steps')
                    .select('*')
                    .order('step_order');

                if (error) throw error;
                
                trainingSteps = steps;
            } catch (error) {
                console.error('Error loading training steps:', error);
                showAlert('Failed to load training steps: ' + error.message, 'warning');
            }
        }

        // Load training progress
        async function loadTrainingProgress() {
            try {
                const { data: progress, error } = await supabase
                    .from('training_progress')
                    .select(`
                        *,
                        trainer:assigned_trainer_id (
                            id,
                            email,
                            first_name,
                            last_name
                        )
                    `)
                    .eq('prospect_id', prospectId);

                if (error) throw error;
                
                trainingProgress = progress;
            } catch (error) {
                console.error('Error loading training progress:', error);
                showAlert('Failed to load training progress: ' + error.message, 'warning');
            }
        }

        // Load trainers for assignment dropdown
        async function loadTrainers() {
            try {
                const { data: trainers, error } = await supabase
                    .from('users')
                    .select('id, email, first_name, last_name, role')
                    .in('role', ['Veteran', 'Manager', 'Admin'])
                    .order('first_name', 'last_name', 'email');

                if (error) throw error;
                
                allTrainers = trainers;
                populateTrainerDropdown();
            } catch (error) {
                console.error('Error loading trainers:', error);
                showAlert('Failed to load trainers: ' + error.message, 'warning');
            }
        }

        // Populate trainer dropdown
        function populateTrainerDropdown() {
            const trainerSelect = document.getElementById('trainer-select');
            
            // Clear existing options except the first one
            trainerSelect.innerHTML = '<option value="">Choose a trainer...</option>';
            
            allTrainers.forEach(trainer => {
                const displayName = trainer.first_name && trainer.last_name ? 
                    `${trainer.first_name} ${trainer.last_name}` : 
                    trainer.email;
                
                const option = document.createElement('option');
                option.value = trainer.id;
                option.textContent = `${displayName} (${trainer.role})`;
                trainerSelect.appendChild(option);
            });
        }

        // Load assigned trainers for this prospect
        async function loadAssignedTrainers() {
            try {
                // For now, we'll create a simple prospect_trainers table in the database
                // But for immediate functionality, let's check if any trainers are assigned to steps
                const assignedTrainerIds = new Set();
                
                // Get all unique trainer IDs from training progress
                trainingProgress.forEach(progress => {
                    if (progress.assigned_trainer_id) {
                        assignedTrainerIds.add(progress.assigned_trainer_id);
                    }
                });

                // Get trainer details
                if (assignedTrainerIds.size > 0) {
                    const { data: trainers, error } = await supabase
                        .from('users')
                        .select('id, email, first_name, last_name, role')
                        .in('id', Array.from(assignedTrainerIds));
                    
                    if (error) throw error;
                    assignedTrainers = trainers;
                } else {
                    assignedTrainers = [];
                }
                
                renderAssignedTrainers();
            } catch (error) {
                console.error('Error loading assigned trainers:', error);
                showAlert('Failed to load assigned trainers: ' + error.message, 'warning');
            }
        }

        // Render assigned trainers list
        function renderAssignedTrainers() {
            const container = document.getElementById('assigned-trainers-list');
            
            if (assignedTrainers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6c757d; font-style: italic;">
                        No trainers assigned yet. Click "Add Trainer" to assign someone to oversee this rep's training.
                    </div>
                `;
                return;
            }

            let html = '<div style="display: grid; gap: 15px;">';
            
            assignedTrainers.forEach(trainer => {
                const displayName = trainer.first_name && trainer.last_name ? 
                    `${trainer.first_name} ${trainer.last_name}` : 
                    trainer.email;
                
                // Count assigned steps
                const assignedSteps = trainingProgress.filter(p => p.assigned_trainer_id === trainer.id).length;
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border: 1px solid #e8ecef; border-radius: 8px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #2c3e50;">${displayName}</div>
                            <div style="font-size: 14px; color: #6c757d;">${trainer.role} â€¢ ${assignedSteps} step${assignedSteps !== 1 ? 's' : ''} assigned</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-outline-warning btn-sm" onclick="reassignTrainerSteps(${trainer.id})" title="Reassign this trainer's steps">Reassign</button>
                            <button class="btn btn-outline-danger btn-sm" onclick="removeTrainer(${trainer.id})" title="Remove this trainer">Remove</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Populate global trainer dropdown
        function populateGlobalTrainerDropdown() {
            const trainerSelect = document.getElementById('global-trainer-select');
            
            // Clear existing options
            trainerSelect.innerHTML = '<option value="">Choose a trainer...</option>';
            
            allTrainers.forEach(trainer => {
                const displayName = trainer.first_name && trainer.last_name ? 
                    `${trainer.first_name} ${trainer.last_name}` : 
                    trainer.email;
                
                const option = document.createElement('option');
                option.value = trainer.id;
                option.textContent = `${displayName} (${trainer.role})`;
                trainerSelect.appendChild(option);
            });
        }

        // Open global assign trainer modal
        function openGlobalAssignTrainerModal() {
            populateGlobalTrainerDropdown();
            populateStepsChecklist();
            document.getElementById('global-trainer-notes').value = '';
            document.querySelector('input[name="assignment-type"][value="all"]').checked = true;
            document.getElementById('specific-steps-selection').style.display = 'none';
            document.getElementById('global-assign-trainer-modal').style.display = 'block';
        }

        // Populate steps checklist for specific assignment
        function populateStepsChecklist(selectedTrainerId = null) {
            const container = document.getElementById('steps-checklist');
            let html = '';
            
            trainingSteps.forEach(step => {
                const progress = trainingProgress.find(p => p.training_step_id === step.id);
                const currentTrainerId = progress ? progress.assigned_trainer_id : null;
                
                // Step is available if:
                // 1. No trainer assigned, OR
                // 2. Already assigned to the selected trainer
                const isAvailable = !currentTrainerId || (selectedTrainerId && currentTrainerId === parseInt(selectedTrainerId));
                const isAssignedToOther = currentTrainerId && selectedTrainerId && currentTrainerId !== parseInt(selectedTrainerId);
                const isAssignedToSelected = currentTrainerId && selectedTrainerId && currentTrainerId === parseInt(selectedTrainerId);
                
                let statusText = '';
                if (isAssignedToSelected) {
                    statusText = '<div style="font-size: 11px; color: #28a745; margin-top: 2px;">Already assigned to this trainer</div>';
                } else if (isAssignedToOther) {
                    const assignedTrainer = allTrainers.find(t => t.id === currentTrainerId);
                    const trainerName = assignedTrainer ? 
                        (assignedTrainer.first_name && assignedTrainer.last_name ? 
                            `${assignedTrainer.first_name} ${assignedTrainer.last_name}` : 
                            assignedTrainer.email) : 
                        'Unknown';
                    statusText = `<div style="font-size: 11px; color: #dc3545; margin-top: 2px;">Assigned to ${trainerName}</div>`;
                }
                
                html += `
                    <label style="display: flex; align-items: center; padding: 8px; margin-bottom: 5px; ${!isAvailable ? 'color: #6c757d;' : ''}" ${!isAvailable ? 'title="Assigned to another trainer"' : ''}>
                        <input type="checkbox" value="${step.id}" ${!isAvailable ? 'disabled' : ''} ${isAssignedToSelected ? 'checked' : ''} style="margin-right: 10px;" class="step-checkbox">
                        <div>
                            <div style="font-weight: 600;">${step.title}</div>
                            ${step.description ? `<div style="font-size: 12px; color: #6c757d; margin-top: 2px;">${step.description}</div>` : ''}
                            ${statusText}
                        </div>
                    </label>
                `;
            });
            
            container.innerHTML = html;
        }

        // Close global assign trainer modal
        function closeGlobalAssignTrainerModal() {
            document.getElementById('global-assign-trainer-modal').style.display = 'none';
        }

        // Remove trainer from prospect
        async function removeTrainer(trainerId) {
            if (!confirm('Are you sure you want to remove this trainer? This will unassign them from all training steps.')) {
                return;
            }
            
            try {
                // Remove trainer from all progress records for this prospect
                const { error } = await supabase
                    .from('training_progress')
                    .update({ assigned_trainer_id: null })
                    .eq('prospect_id', prospectId)
                    .eq('assigned_trainer_id', trainerId);
                
                if (error) throw error;
                
                showAlert('Trainer removed successfully!', 'success');
                
                // Refresh data
                await loadTrainingProgress();
                await loadAssignedTrainers();
                renderTrainingTimeline();
                
            } catch (error) {
                console.error('Error removing trainer:', error);
                showAlert('Failed to remove trainer: ' + error.message, 'warning');
            }
        }

        // Check permissions and load global notes based on role
        async function checkPermissionsAndLoadGlobalNotes() {
            try {
                // Check if user has access to this rep's profile
                const hasAccess = await checkRepAccessPermissions();
                
                if (hasAccess) {
                    await loadGlobalInternalNotes();
                }
                
            } catch (error) {
                console.error('Error checking permissions and loading global notes:', error);
            }
        }

        // Check if current user has access to view this rep's profile
        async function checkRepAccessPermissions() {
            // Admins can see all reps
            if (currentSession.role === 'Admin') {
                return true;
            }
            
            // Veterans can see all reps (since they can train anyone)
            if (currentSession.role === 'Veteran') {
                return true;
            }
            
            // Managers can only see reps in their CRM
            if (currentSession.role === 'Manager') {
                const { data: prospect, error } = await supabase
                    .from('prospects')
                    .select('assigned_recruiter_id')
                    .eq('id', prospectId)
                    .single();
                    
                if (error) throw error;
                
                // Check if this manager is the assigned recruiter or if no one is assigned
                return prospect.assigned_recruiter_id === currentSession.userId || !prospect.assigned_recruiter_id;
            }
            
            // Rookies can only see their own profile
            if (currentSession.role === 'Rookie') {
                return prospectData.id === currentSession.userId;
            }
            
            return false;
        }

        // Load global internal notes
        async function loadGlobalInternalNotes() {
            try {
                // Use the new global_internal_notes column in prospects table
                const { data: prospect, error } = await supabase
                    .from('prospects')
                    .select('global_internal_notes')
                    .eq('id', prospectId)
                    .single();
                    
                if (error) throw error;
                
                // Parse the internal notes if they exist
                if (prospect.global_internal_notes) {
                    try {
                        globalInternalNotes = JSON.parse(prospect.global_internal_notes);
                    } catch (parseError) {
                        globalInternalNotes = [];
                    }
                } else {
                    globalInternalNotes = [];
                }
                
            } catch (error) {
                console.error('Error loading global internal notes:', error);
                globalInternalNotes = [];
            }
        }

        // Update UI based on user permissions
        async function updateUIBasedOnPermissions() {
            const hasAccess = await checkRepAccessPermissions();
            
            if (!hasAccess) {
                // User doesn't have access - show error message and redirect
                showAlert('You do not have permission to view this rep profile.', 'warning');
                setTimeout(() => window.location.href = 'crm.html', 2000);
                return;
            }
            
            // Show trainer assignment section for appropriate roles
            if (currentSession.role === 'Manager' || currentSession.role === 'Admin' || currentSession.role === 'Veteran') {
                document.getElementById('trainer-assignment-section').style.display = 'block';
            }
            
            // Hide internal notes button for rookies viewing their own profile
            if (currentSession.role === 'Rookie' && prospectData.id === currentSession.userId) {
                document.getElementById('global-internal-notes-btn').style.display = 'none';
            }
        }

        // Open global internal notes modal
        function openGlobalInternalNotesModal() {
            loadGlobalNotesDisplay();
            document.getElementById('global-internal-notes-text').value = '';
            document.getElementById('global-internal-notes-modal').style.display = 'block';
        }

        // Close global internal notes modal
        function closeGlobalInternalNotesModal() {
            document.getElementById('global-internal-notes-modal').style.display = 'none';
        }

        // Load and display global internal notes
        function loadGlobalNotesDisplay() {
            const container = document.getElementById('global-internal-notes-display');
            
            if (globalInternalNotes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6c757d; font-style: italic;">
                        No internal notes yet. Add the first note below.
                    </div>
                `;
                return;
            }
            
            let html = '';
            globalInternalNotes.forEach((note, index) => {
                const timestamp = new Date(note.created_at).toLocaleString();
                const noteId = note.id || index; // Use note ID if available, otherwise use index
                
                html += `
                    <div style="border-bottom: 1px solid #e8ecef; padding-bottom: 12px; margin-bottom: 12px; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: #2c3e50;">${note.author_name}</div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="note-delete-checkbox" data-note-id="${noteId}" style="margin-right: 5px;" title="Select for deletion">
                                <div style="font-size: 12px; color: #6c757d;">${timestamp}</div>
                            </div>
                        </div>
                        <div style="color: #495057; line-height: 1.5;">${note.content}</div>
                    </div>
                `;
            });
            
            // Add delete controls
            html += `
                <div id="delete-controls" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e8ecef; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 14px; color: #6c757d;">
                            <span id="selected-count">0</span> note(s) selected
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearNoteSelection()">Clear Selection</button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelectedNotes()">Delete Selected</button>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Add event listeners for checkboxes
            document.querySelectorAll('.note-delete-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateDeleteControls);
            });
        }

        // Add global internal note
        async function addGlobalInternalNote(content) {
            try {
                const newNote = {
                    id: Date.now(), // Simple ID generation
                    content: content,
                    author_id: currentSession.userId,
                    author_name: currentSession.firstName && currentSession.lastName ? 
                        `${currentSession.firstName} ${currentSession.lastName}` : 
                        currentSession.email,
                    created_at: new Date().toISOString()
                };
                
                globalInternalNotes.push(newNote);
                
                // Save to database using training_progress with step_id 0
                await saveGlobalNotesToDatabase();
                
                showAlert('Internal note added successfully!', 'success');
                loadGlobalNotesDisplay();
                
            } catch (error) {
                console.error('Error adding global internal note:', error);
                showAlert('Failed to add internal note: ' + error.message, 'warning');
            }
        }

        // Save global notes to database
        async function saveGlobalNotesToDatabase() {
            try {
                const notesJson = JSON.stringify(globalInternalNotes);

                // Update the prospects table with the new global_internal_notes column
                const { error } = await supabase
                    .from('prospects')
                    .update({ global_internal_notes: notesJson })
                    .eq('id', prospectId);
                    
                if (error) throw error;
            } catch (error) {
                throw error;
            }
        }

        // Update delete controls visibility and count
        function updateDeleteControls() {
            const checkboxes = document.querySelectorAll('.note-delete-checkbox:checked');
            const count = checkboxes.length;
            const deleteControls = document.getElementById('delete-controls');
            const countSpan = document.getElementById('selected-count');
            
            if (count > 0) {
                deleteControls.style.display = 'block';
                countSpan.textContent = count;
            } else {
                deleteControls.style.display = 'none';
            }
        }

        // Clear note selection
        function clearNoteSelection() {
            document.querySelectorAll('.note-delete-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateDeleteControls();
        }

        // Delete selected notes
        async function deleteSelectedNotes() {
            const checkboxes = document.querySelectorAll('.note-delete-checkbox:checked');
            const noteIdsToDelete = Array.from(checkboxes).map(cb => cb.getAttribute('data-note-id'));
            
            if (noteIdsToDelete.length === 0) {
                showAlert('Please select notes to delete.', 'warning');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${noteIdsToDelete.length} note(s)? This action cannot be undone.`)) {
                return;
            }
            
            try {
                // Remove selected notes from the array
                globalInternalNotes = globalInternalNotes.filter(note => {
                    const noteId = note.id || globalInternalNotes.indexOf(note);
                    return !noteIdsToDelete.includes(noteId.toString());
                });
                
                // Save updated notes to database
                await saveGlobalNotesToDatabase();
                
                showAlert(`${noteIdsToDelete.length} note(s) deleted successfully!`, 'success');
                loadGlobalNotesDisplay();
                
            } catch (error) {
                console.error('Error deleting notes:', error);
                showAlert('Failed to delete notes: ' + error.message, 'warning');
            }
        }

        // Open assign trainer modal
        function assignTrainer(stepId) {
            document.getElementById('assign-step-id').value = stepId;
            document.getElementById('trainer-notes').value = '';
            document.getElementById('assign-trainer-modal').style.display = 'block';
        }

        // Close assign trainer modal
        function closeAssignTrainerModal() {
            document.getElementById('assign-trainer-modal').style.display = 'none';
            document.getElementById('assign-trainer-form').reset();
        }

        // Handle assign trainer form submission
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('assign-trainer-form').addEventListener('submit', async function(e) {
                e.preventDefault();

                const stepId = document.getElementById('assign-step-id').value;
                const trainerId = document.getElementById('trainer-select').value;
                const notes = document.getElementById('trainer-notes').value.trim();

                if (!trainerId) {
                    showAlert('Please select a trainer', 'warning');
                    return;
                }

                try {
                    // Check if progress record exists
                    let progress = trainingProgress.find(p => p.training_step_id == stepId);
                    
                    if (!progress) {
                        // Create new progress record
                        const { data: newProgress, error: insertError } = await supabase
                            .from('training_progress')
                            .insert([{
                                prospect_id: prospectId,
                                training_step_id: stepId,
                                status: 'in_progress',
                                assigned_trainer_id: trainerId,
                                started_date: new Date().toISOString(),
                                public_notes: notes || null
                            }])
                            .select()
                            .single();

                        if (insertError) throw insertError;
                    } else {
                        // Update existing progress record
                        const updateData = {
                            assigned_trainer_id: trainerId,
                            updated_at: new Date().toISOString()
                        };

                        // If step hasn't started yet, start it and add notes
                        if (progress.status === 'not_started' || !progress.started_date) {
                            updateData.status = 'in_progress';
                            updateData.started_date = new Date().toISOString();
                        }

                        // Add notes if provided and no existing notes
                        if (notes && !progress.public_notes) {
                            updateData.public_notes = notes;
                        }

                        const { error: updateError } = await supabase
                            .from('training_progress')
                            .update(updateData)
                            .eq('id', progress.id);

                        if (updateError) throw updateError;
                    }

                    showAlert('Trainer assigned successfully!', 'success');
                    closeAssignTrainerModal();
                    
                    // Refresh the data and re-render
                    await loadTrainingProgress();
                    renderProgressOverview();
                    renderTrainingTimeline();

                } catch (error) {
                    console.error('Error assigning trainer:', error);
                    showAlert('Failed to assign trainer: ' + error.message, 'warning');
                }
            });

            // Close modal when clicking outside
            document.getElementById('assign-trainer-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAssignTrainerModal();
                }
            });

            // Global assign trainer form handler
            document.getElementById('global-assign-trainer-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const trainerId = document.getElementById('global-trainer-select').value;
                const notes = document.getElementById('global-trainer-notes').value.trim();
                
                if (!trainerId) {
                    showAlert('Please select a trainer', 'warning');
                    return;
                }
                
                try {
                    const assignmentType = document.querySelector('input[name="assignment-type"]:checked').value;
                    let stepsToAssign = [];
                    
                    if (assignmentType === 'all') {
                        // Get all training steps that don't have assigned trainers yet
                        stepsToAssign = trainingSteps.filter(step => {
                            const progress = trainingProgress.find(p => p.training_step_id === step.id);
                            return !progress || !progress.assigned_trainer_id;
                        });
                        
                        if (stepsToAssign.length === 0) {
                            showAlert('All training steps already have assigned trainers. Use specific step assignment instead.', 'warning');
                            return;
                        }
                    } else {
                        // Get selected specific steps (excluding those already assigned to this trainer)
                        const checkedBoxes = document.querySelectorAll('#steps-checklist input[type="checkbox"]:checked:not([disabled])');
                        const selectedStepIds = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
                        
                        if (selectedStepIds.length === 0) {
                            showAlert('Please select at least one training step to assign.', 'warning');
                            return;
                        }
                        
                        // Filter to only steps that aren't already assigned to this trainer
                        stepsToAssign = trainingSteps.filter(step => {
                            if (!selectedStepIds.includes(step.id)) return false;
                            
                            const progress = trainingProgress.find(p => p.training_step_id === step.id);
                            const currentTrainerId = progress ? progress.assigned_trainer_id : null;
                            
                            // Include if no trainer assigned or if reassigning from different trainer
                            return !currentTrainerId || currentTrainerId !== parseInt(trainerId);
                        });
                        
                        if (stepsToAssign.length === 0) {
                            showAlert('Selected steps are already assigned to this trainer.', 'warning');
                            return;
                        }
                    }
                    
                    // Assign trainer to selected steps
                    for (const step of stepsToAssign) {
                        let progress = trainingProgress.find(p => p.training_step_id === step.id);
                        
                        if (!progress) {
                            // Create new progress record
                            const { error: insertError } = await supabase
                                .from('training_progress')
                                .insert([{
                                    prospect_id: prospectId,
                                    training_step_id: step.id,
                                    status: 'in_progress',
                                    assigned_trainer_id: trainerId,
                                    started_date: new Date().toISOString(),
                                    public_notes: notes || null
                                }]);
                            
                            if (insertError) throw insertError;
                        } else {
                            // Update existing progress record (reassignment)
                            const updateData = {
                                assigned_trainer_id: trainerId,
                                updated_at: new Date().toISOString()
                            };
                            
                            // Start the step if it hasn't started yet
                            if (progress.status === 'not_started' || !progress.started_date) {
                                updateData.status = 'in_progress';
                                updateData.started_date = new Date().toISOString();
                            }
                            
                            // Only add notes if there aren't existing notes
                            if (notes && !progress.public_notes) {
                                updateData.public_notes = notes;
                            }
                            
                            const { error: updateError } = await supabase
                                .from('training_progress')
                                .update(updateData)
                                .eq('id', progress.id);
                            
                            if (updateError) throw updateError;
                        }
                    }
                    
                    showAlert(`Trainer assigned to ${stepsToAssign.length} training step${stepsToAssign.length !== 1 ? 's' : ''}!`, 'success');
                    closeGlobalAssignTrainerModal();
                    
                    // Refresh the data and re-render
                    await loadTrainingProgress();
                    await loadAssignedTrainers();
                    renderProgressOverview();
                    renderTrainingTimeline();
                    
                } catch (error) {
                    console.error('Error assigning trainer:', error);
                    showAlert('Failed to assign trainer: ' + error.message, 'warning');
                }
            });

            // Close global modal when clicking outside
            document.getElementById('global-assign-trainer-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeGlobalAssignTrainerModal();
                }
            });

            // Global internal notes form handler
            document.getElementById('global-internal-notes-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const content = document.getElementById('global-internal-notes-text').value.trim();
                if (!content) return;
                
                await addGlobalInternalNote(content);
                document.getElementById('global-internal-notes-text').value = '';
            });

            // Close global internal notes modal when clicking outside
            document.getElementById('global-internal-notes-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeGlobalInternalNotesModal();
                }
            });

            // Assignment type radio button handlers
            document.querySelectorAll('input[name="assignment-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const specificSelection = document.getElementById('specific-steps-selection');
                    if (this.value === 'specific') {
                        specificSelection.style.display = 'block';
                        // Update checklist when switching to specific mode
                        const selectedTrainerId = document.getElementById('global-trainer-select').value;
                        populateStepsChecklist(selectedTrainerId);
                    } else {
                        specificSelection.style.display = 'none';
                    }
                });
            });

            // Trainer selection change handler
            document.getElementById('global-trainer-select').addEventListener('change', function() {
                const selectedTrainerId = this.value;
                const assignmentType = document.querySelector('input[name="assignment-type"]:checked').value;
                
                // Only update checklist if in specific mode
                if (assignmentType === 'specific') {
                    populateStepsChecklist(selectedTrainerId);
                }
            });
        });

        // Render prospect information
        function renderProspectInfo() {
            if (!prospectData) return;

            const recruiterName = prospectData.recruiter ? 
                (prospectData.recruiter.first_name && prospectData.recruiter.last_name ? 
                    `${prospectData.recruiter.first_name} ${prospectData.recruiter.last_name}` : 
                    prospectData.recruiter.email) : 
                'Unassigned';

            const contactInfo = [
                prospectData.email ? `ðŸ“§ ${prospectData.email}` : '',
                prospectData.phone ? `ðŸ“ž ${prospectData.phone}` : ''
            ].filter(Boolean).join(' â€¢ ');

            document.getElementById('prospect-info').innerHTML = `
                <div class="info-item">
                    <div class="info-label">Full Name</div>
                    <div class="info-value">${prospectData.first_name} ${prospectData.last_name}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value">
                        <span class="status-badge status-${prospectData.status}">
                            ${prospectData.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                        </span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Assigned Recruiter</div>
                    <div class="info-value">${recruiterName}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Contact</div>
                    <div class="info-value">${contactInfo || 'No contact info'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Source</div>
                    <div class="info-value">${prospectData.source ? prospectData.source.charAt(0).toUpperCase() + prospectData.source.slice(1) : 'Unknown'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Added</div>
                    <div class="info-value">${new Date(prospectData.created_at).toLocaleDateString()}</div>
                </div>
            `;
        }

        // Render progress overview
        function renderProgressOverview() {
            const totalSteps = trainingSteps.length;
            const completedSteps = trainingProgress.filter(p => p.status === 'completed').length;
            const inProgressSteps = trainingProgress.filter(p => p.status === 'in_progress').length;
            const selfCompletedSteps = trainingProgress.filter(p => p.rep_self_completed && !p.trainer_verified).length;
            
            const progressPercentage = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;

            document.getElementById('progress-stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number stat-completed">${completedSteps}</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-pending">${inProgressSteps}</div>
                    <div class="stat-label">In Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #17a2b8;">${selfCompletedSteps}</div>
                    <div class="stat-label">Self-Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-total">${totalSteps}</div>
                    <div class="stat-label">Total Steps</div>
                </div>
            `;

            document.getElementById('overall-progress-bar').style.width = progressPercentage + '%';
            document.getElementById('progress-text').textContent = `${progressPercentage}% Complete (${completedSteps} of ${totalSteps} steps)`;
        }

        // Render training timeline
        function renderTrainingTimeline() {
            let timelineHtml = '';

            trainingSteps.forEach((step, index) => {
                const progress = trainingProgress.find(p => p.training_step_id === step.id);
                
                let stepStatus = 'pending';
                let stepClass = 'step-pending';
                let iconContent = index + 1;

                if (progress) {
                    if (progress.status === 'completed') {
                        stepStatus = 'completed';
                        stepClass = 'step-completed';
                        iconContent = 'âœ“';
                    } else if (progress.status === 'in_progress') {
                        stepStatus = 'current';
                        stepClass = 'step-current';
                        iconContent = 'â—';
                    } else if (progress.rep_self_completed && !progress.trainer_verified) {
                        stepStatus = 'self-completed';
                        stepClass = 'step-self-completed';
                        iconContent = '?';
                    }
                }

                timelineHtml += renderTrainingStep(step, progress, stepClass, iconContent, stepStatus);
            });

            document.getElementById('training-timeline').innerHTML = timelineHtml;
        }

        // Render individual training step
        function renderTrainingStep(step, progress, stepClass, iconContent, stepStatus) {
            const canEdit = currentSession.role !== 'Rookie' || 
                           (progress && progress.assigned_trainer_id === currentSession.userId);
            
            const isAssignedRep = prospectData && 
                                 (prospectData.assigned_recruiter_id === currentSession.userId ||
                                  currentSession.role === 'Admin' ||
                                  currentSession.role === 'Manager');

            let statusText = 'Not Started';
            let metaInfo = '';

            if (progress) {
                if (progress.status === 'completed') {
                    statusText = 'Completed';
                    metaInfo = `Completed on ${new Date(progress.completed_date).toLocaleDateString()}`;
                    if (progress.trainer) {
                        const trainerName = progress.trainer.first_name && progress.trainer.last_name ?
                            `${progress.trainer.first_name} ${progress.trainer.last_name}` :
                            progress.trainer.email;
                        metaInfo += ` by ${trainerName}`;
                    }
                } else if (progress.status === 'in_progress') {
                    statusText = 'In Progress';
                    if (progress.started_date) {
                        metaInfo = `Started on ${new Date(progress.started_date).toLocaleDateString()}`;
                    }
                    if (progress.trainer) {
                        const trainerName = progress.trainer.first_name && progress.trainer.last_name ?
                            `${progress.trainer.first_name} ${progress.trainer.last_name}` :
                            progress.trainer.email;
                        metaInfo += ` - Trainer: ${trainerName}`;
                    }
                } else if (progress.rep_self_completed && !progress.trainer_verified) {
                    statusText = 'Self-Completed (Awaiting Verification)';
                    if (progress.rep_completion_date) {
                        metaInfo = `Self-completed on ${new Date(progress.rep_completion_date).toLocaleDateString()}`;
                    }
                }
                
                if (step.estimated_hours > 0) {
                    metaInfo += ` â€¢ Estimated: ${step.estimated_hours} hours`;
                }
            } else if (step.estimated_hours > 0) {
                metaInfo = `Estimated: ${step.estimated_hours} hours`;
            }

            return `
                <div class="timeline-step">
                    <div class="step-icon ${stepClass}">
                        ${iconContent}
                    </div>
                    <div class="step-content">
                        <div class="step-header">
                            <div>
                                <div class="step-title">${step.step_name}</div>
                                <div class="step-meta">
                                    <strong>${statusText}</strong>
                                    ${metaInfo ? ` â€¢ ${metaInfo}` : ''}
                                </div>
                            </div>
                        </div>
                        
                        ${step.description ? `<p style="margin-bottom: 15px; color: #495057;">${step.description}</p>` : ''}
                        
                        ${renderStepActions(step, progress, canEdit, isAssignedRep, stepStatus)}
                        
                        ${renderStepNotes(step, progress, canEdit)}
                    </div>
                </div>
            `;
        }

        // Render step actions
        function renderStepActions(step, progress, canEdit, isAssignedRep, stepStatus) {
            let actionsHtml = '<div class="step-actions">';

            // Self-completion action (for reps)
            if (isAssignedRep && stepStatus !== 'completed' && (!progress || !progress.rep_self_completed)) {
                actionsHtml += `<button class="btn btn-info btn-sm" onclick="markSelfCompleted(${step.id})">Mark as Self-Completed</button>`;
            }

            // Trainer actions
            if (canEdit) {
                if (!progress) {
                    actionsHtml += `<button class="btn btn-warning btn-sm" onclick="startStep(${step.id})">Start Step</button>`;
                } else if (progress.status === 'in_progress' || progress.rep_self_completed) {
                    actionsHtml += `<button class="btn btn-success btn-sm" onclick="completeStep(${step.id})">Mark Complete</button>`;
                }
                
                if (progress && progress.status !== 'completed') {
                    actionsHtml += `<button class="btn btn-secondary btn-sm" onclick="assignTrainer(${step.id})">Assign Trainer</button>`;
                }
            }

            actionsHtml += '</div>';
            return actionsHtml;
        }

        // Render step notes
        function renderStepNotes(step, progress, canEdit) {
            if (!progress) return '';
            
            let notesHtml = '<div class="notes-section">';
            
            // Only show rep notes now - internal notes moved to global system
            notesHtml += '<div class="notes-buttons" style="margin-bottom: 15px;">';
            
            // Section Notes button - show to everyone
            notesHtml += `
                <button class="btn btn-outline-primary btn-sm" onclick="toggleNotesSection(${step.id}, 'public')" id="section-notes-btn-${step.id}">
                    Section Notes
                </button>
            `;
            
            notesHtml += '</div>';
            
            // Section notes section only
            notesHtml += `
                <div id="public-notes-section-${step.id}" class="notes-content" style="display: none; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px; color: #2c3e50;">Section Notes</h4>
                    <div class="notes-display ${!progress.public_notes ? 'empty' : ''}" id="public-display-${step.id}">
                        ${progress.public_notes || 'No notes for this section yet...'}
                    </div>
                    ${canEdit ? `
                        <textarea id="public-notes-${step.id}" placeholder="Add notes about this training section..." style="width: 100%; padding: 12px; border: 2px solid #e8ecef; border-radius: 8px; font-size: 14px; min-height: 80px; margin-top: 10px;">${progress.public_notes || ''}</textarea>
                        <button class="btn btn-success btn-sm" onclick="saveNotes(${step.id}, 'public')" style="margin-top: 10px;">Save Section Notes</button>
                    ` : ''}
                </div>
            `;
            
            notesHtml += '</div>';
            return notesHtml;
        }

        // Toggle notes section visibility
        function toggleNotesSection(stepId, notesType) {
            const sectionId = `${notesType}-notes-section-${stepId}`;
            const section = document.getElementById(sectionId);
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        }

        // Mark step as self-completed (for reps)
        async function markSelfCompleted(stepId) {
            try {
                // First check if progress record exists
                let progress = trainingProgress.find(p => p.training_step_id === stepId);
                
                if (!progress) {
                    // Create progress record if it doesn't exist
                    const { data: newProgress, error: insertError } = await supabase
                        .from('training_progress')
                        .insert([{
                            prospect_id: prospectId,
                            training_step_id: stepId,
                            status: 'in_progress',
                            rep_self_completed: true,
                            rep_completion_date: new Date().toISOString(),
                            started_date: new Date().toISOString()
                        }])
                        .select()
                        .single();

                    if (insertError) throw insertError;
                    progress = newProgress;
                } else {
                    // Update existing progress record
                    const { data: updatedProgress, error: updateError } = await supabase
                        .from('training_progress')
                        .update({
                            rep_self_completed: true,
                            rep_completion_date: new Date().toISOString()
                        })
                        .eq('id', progress.id)
                        .select()
                        .single();

                    if (updateError) throw updateError;
                    progress = updatedProgress;
                }

                showAlert('Step marked as self-completed! Your trainer will be notified.', 'success');
                
                // Refresh the data and re-render
                await loadTrainingProgress();
                renderProgressOverview();
                renderTrainingTimeline();

            } catch (error) {
                console.error('Error marking step as self-completed:', error);
                showAlert('Failed to mark step as self-completed: ' + error.message, 'warning');
            }
        }

        // Start a training step (for trainers)
        async function startStep(stepId) {
            try {
                const { data: progress, error } = await supabase
                    .from('training_progress')
                    .upsert([{
                        prospect_id: prospectId,
                        training_step_id: stepId,
                        status: 'in_progress',
                        assigned_trainer_id: currentSession.userId,
                        started_date: new Date().toISOString()
                    }])
                    .select()
                    .single();

                if (error) throw error;

                showAlert('Training step started successfully!', 'success');
                
                // Refresh the data and re-render
                await loadTrainingProgress();
                renderProgressOverview();
                renderTrainingTimeline();

            } catch (error) {
                console.error('Error starting step:', error);
                showAlert('Failed to start training step: ' + error.message, 'warning');
            }
        }

        // Complete a training step (for trainers)
        async function completeStep(stepId) {
            try {
                const progress = trainingProgress.find(p => p.training_step_id === stepId);
                if (!progress) throw new Error('Progress record not found');

                const { data: updatedProgress, error } = await supabase
                    .from('training_progress')
                    .update({
                        status: 'completed',
                        completed_date: new Date().toISOString(),
                        trainer_verified: true
                    })
                    .eq('id', progress.id)
                    .select()
                    .single();

                if (error) throw error;

                showAlert('Training step completed successfully!', 'success');
                
                // Refresh the data and re-render
                await loadTrainingProgress();
                renderProgressOverview();
                renderTrainingTimeline();

            } catch (error) {
                console.error('Error completing step:', error);
                showAlert('Failed to complete training step: ' + error.message, 'warning');
            }
        }

        // Save notes
        async function saveNotes(stepId, noteType) {
            try {
                const progress = trainingProgress.find(p => p.training_step_id === stepId);
                if (!progress) throw new Error('Progress record not found');

                const noteText = document.getElementById(`${noteType}-notes-${stepId}`).value.trim();
                const updateField = noteType === 'public' ? 'public_notes' : 'internal_notes';

                const { error } = await supabase
                    .from('training_progress')
                    .update({
                        [updateField]: noteText || null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', progress.id);

                if (error) throw error;

                // Update the display
                document.getElementById(`${noteType}-display-${stepId}`).textContent = 
                    noteText || (noteType === 'public' ? 'No shared notes yet...' : 'No internal notes yet...');
                document.getElementById(`${noteType}-display-${stepId}`).className = 
                    `notes-display ${noteText ? '' : 'empty'}`;

                showAlert(`${noteType === 'public' ? 'Shared' : 'Internal'} notes saved successfully!`, 'success');
                
                // Refresh training progress data
                await loadTrainingProgress();

            } catch (error) {
                console.error('Error saving notes:', error);
                showAlert('Failed to save notes: ' + error.message, 'warning');
            }
        }

        // Show alert message
        function showAlert(message, type) {
            const alertDiv = document.getElementById('alert-message');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type} show`;

            setTimeout(() => {
                alertDiv.classList.remove('show');
            }, 4000);
        }

        // Logout function
        function logout() {
            localStorage.removeItem('gritSession');
            window.location.href = 'login.html';
        }

        // Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const hamburgerIcon = document.querySelector('.hamburger-icon');
            
            sidebar.classList.toggle('expanded');
            hamburgerIcon.classList.toggle('active');
            
            // Toggle overlay for mobile
            if (window.innerWidth <= 768) {
                overlay.classList.toggle('active');
            }
        }

        // Initialize the page
        init();
    </script>
</body>
</html>